<html>
<head>
    <title>RPG</title>
    <meta charset="utf-8">
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="/rpg-1.0-SNAPSHOT/css/my.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://icons.getbootstrap.com/assets/font/bootstrap-icons.min.css">
</head>
<body>
<h1>RPG admin panel</h1>
<h2>Accounts list:</h2>
<form>
    <label for="pages">Count per page:</label>
    <select id="pages" class="form-select">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
    </select>
</form>
<table id="accountListTable" class="table table-bordered">
    <thead>
    <tr>
        <th id="id">#</th>
        <th id="name">Name</th>
        <th id="title">Title</th>
        <th id="race">Race</th>
        <th id="profession">Profession</th>
        <th id="level">Level</th>
        <th id="birthday">Birthday</th>
        <th id="banned">Banned</th>
        <th id="edit">Edit</th>
        <th id="del">Delete</th>
    </tr>
    </thead>
    <tbody id="bodyId">
    <tr>
    </tr>
    </tbody>
</table>
<div id="btns" class="div btn-group">
    <div class="div">Pages:</div>
    <button>11</button>
</div>
<script>
    let $j = jQuery.noConflict();
    let currentBtn;

    async function getDataForTable(pageNumber) {
        var tBodyForClear = document.getElementById("bodyId");
        while (tBodyForClear.firstChild) {
            tBodyForClear.removeChild(tBodyForClear.firstChild);
        }

        const accountsCount = await countingPlayers();
        const select = document.getElementById('pages');
        const rowsCount = parseInt(select.value, 10);
        if (pageNumber == 0) {
            countingPages(accountsCount, rowsCount);
        }

        const dataPlayers = await $j.get('/rpg-1.0-SNAPSHOT/rest/players?pageNumber='+pageNumber+'&pageSize='+rowsCount);
        var table = document.getElementById("accountListTable");
        dataPlayers.forEach(d => {
        const r = document.createElement('tr');
        table.querySelectorAll('th').forEach(header => {
                                                    const cell = r.insertCell();
                                                    const propertyName = header.getAttribute('id');
                                                    const value = d[propertyName];
                                                    cell.textContent = value;
                                                    if (propertyName === 'edit') {
                                                        cell.width = 41;
                                                        cell.height = 41;
                                                        cell.align = 'center';
                                                        cell.innerHTML = '<i class="bi bi-pencil"></i>';
                                                    }
                                                    if (propertyName === 'del') {
                                                        cell.width = 41;
                                                        cell.height = 41;
                                                        cell.align = 'center';
                                                        cell.innerHTML = '<i class="bi bi-trash"></i>';
                                                        cell.addEventListener('click', deleteAccount);
                                                    }
                                                   }
                                              );
        table.querySelector('tbody').insertAdjacentElement('beforeend', r);
        });
    };

    getDataForTable(0);

    async function countingPlayers() {
        return await $j.get('/rpg-1.0-SNAPSHOT/rest/players/count');
    };

    //Функция отображения кнопок страниц
    function countingPages(allCount, countPerPage, del) {
        var div = document.getElementById("btns");
        div.innerHTML = '<div class="div">Pages:</div>';
            for (let i = 0; i < allCount/countPerPage; i++) {
                const button = document.createElement('button');
                if (i === 0 && del === undefined) {
                    button.className = 'btn btn-primary';
                    currentBtn = button;
                } else {
                    if (i === del) {
                        button.className = 'btn btn-primary';
                        currentBtn = button;
                    } else {
                        button.className = 'btn btn-secondary'
                    }
                }
                button.textContent = i+1;
                button.id = 'id'+(i+1);
                button.addEventListener('click', () => {handleBtnChange(button.id);});
                div.insertAdjacentElement('beforeend', button);
            }
    };

    // Функция для обработки выбора в выпадающем списке
    async function handlePageChange() {
        const select = document.getElementById('pages');
        const selectedValue = parseInt(select.value, 10);
        const playersCount = await countingPlayers();
        countingPages(playersCount, selectedValue);
        getDataForTable(0);
    }

    // Добавляем обработчик события change в выпадающем списке
    document.getElementById('pages').addEventListener('change', handlePageChange);

    // Функция для обработки выбора в кнопках
    function handleBtnChange(id) {
        const select = document.getElementById(id);
        currentBtn.className = 'btn btn-secondary';
        select.className = 'btn btn-primary';
        currentBtn = select;
        const selectedValue = parseInt(select.textContent, 10);
        getDataForTable(selectedValue-1);
    }

    async function deleteAccount(event) {

        const clickedRow = event.target.closest('td').closest('tr');
        const idPlayer = clickedRow.cells[0].textContent;
        try {
            // Выполняем асинхронный запрос на удаление
            await $j.ajax({
                url: '/rpg-1.0-SNAPSHOT/rest/players/' + idPlayer,
                type: 'DELETE',
                success: async function(response) {
                    console.log('Удален игрок с ID:', idPlayer);
                    const select = document.getElementById('pages');
                    const selectedValue = parseInt(select.value, 10);
                    const playersCount = await countingPlayers();
                    countingPages(playersCount, selectedValue, parseInt(currentBtn.textContent, 10)-1);
                    getDataForTable(parseInt(currentBtn.textContent, 10)-1); // Обновляем таблицу
                },
                error: function(error) {
                    console.error('Ошибка при удалении игрока:', error);
                }
            });
        } catch (error) {
            console.error('Ошибка при удаления игрока:', error);
        }
    }


</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
</body>
</html>